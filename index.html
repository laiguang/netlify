<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cozy Focus Timer</title>
    <!-- 引入圆润可爱的字体 -->
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Nunito:wght@600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            /* 默认春季主题 */
            --bg-color: #FFB7B2;
            --wood-light: #FFDAC1;
            --wood-dark: #E27D60;
            --ui-bg: #FFF5F0;
            --text-color: #6D4C41;
            --accent-color: #FF9AA2;
            --btn-shadow: #D86C55;
            --particle-color: #FFB7B2;
        }

        /* 主题定义类 */
        body.summer {
            --bg-color: #95D5B2;
            --wood-light: #B7E4C7;
            --wood-dark: #40916C;
            --ui-bg: #F0FFF4;
            --text-color: #1B4332;
            --accent-color: #74C69D;
            --btn-shadow: #2D6A4F;
        }
        body.autumn {
            --bg-color: #E29578;
            --wood-light: #F6BD60;
            --wood-dark: #A65D48;
            --ui-bg: #FFF8E1;
            --text-color: #5D4037;
            --accent-color: #F4A261;
            --btn-shadow: #8D4E38;
        }
        body.winter {
            --bg-color: #98C1D9;
            --wood-light: #E0FBFC;
            --wood-dark: #3D5A80;
            --ui-bg: #F0F8FF;
            --text-color: #293241;
            --accent-color: #98C1D9;
            --btn-shadow: #2B4566;
        }
        body.dark {
            --bg-color: #293241;
            --wood-light: #3D5A80;
            --wood-dark: #1F2633;
            --ui-bg: #1B263B;
            --text-color: #E0FBFC;
            --accent-color: #415A77;
            --btn-shadow: #0D131E;
        }

        * {
            box-sizing: border-box;
            user-select: none;
            -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            margin: 0;
            padding: 0;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            background-color: var(--bg-color);
            font-family: 'Nunito', sans-serif;
            transition: background-color 0.5s;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* 木纹背景层 */
        .wood-layer {
            position: absolute;
            top: 2vmin;
            bottom: 2vmin;
            left: 2vmin;
            right: 2vmin;
            background-color: var(--wood-light);
            background-image: repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(0,0,0,0.03) 10px, rgba(0,0,0,0.03) 20px);
            border-radius: 40px;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.1), 0 10px 20px rgba(0,0,0,0.1);
            z-index: 1;
            transition: background-color 0.5s;
        }

        /* UI 容器 (Squircle) */
        .ui-container {
            position: absolute;
            top: 4vmin;
            bottom: 4vmin;
            left: 4vmin;
            right: 4vmin;
            background-color: var(--ui-bg);
            border-radius: 30px;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            z-index: 10;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            transition: background-color 0.5s;
        }

        /* 画布层 (粒子) */
        canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 5;
            pointer-events: none;
        }

        /* 上部：角度显示 */
        .angle-display {
            font-family: 'Fredoka One', cursive;
            font-size: 6vmin;
            color: var(--text-color);
            margin-top: 2vh;
            min-height: 1.5em;
        }

        /* 中上部：水平仪 */
        .leveler-container {
            position: relative;
            width: 35vmin;
            height: 35vmin;
            margin: 2vh 0;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .leveler-ring {
            width: 100%;
            height: 100%;
            border: 6px solid #DDD;
            border-radius: 50%;
            position: absolute;
            transition: border-color 0.3s;
        }

        .leveler-error-zone {
            width: 25%; /* 对应大约3-5度的误差范围 */
            height: 25%;
            border: 2px dashed #ff6b6b;
            border-radius: 50%;
            position: absolute;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .leveler-bubble {
            width: 20px;
            height: 20px;
            background-color: #ff6b6b;
            border-radius: 50%;
            position: absolute;
            transform: translate(0, 0);
            transition: background-color 0.3s, width 0.3s, height 0.3s, border 0.3s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        /* 水平状态样式 */
        .is-level .leveler-ring {
            border-color: #4CAF50;
        }
        .is-level .leveler-bubble {
            background-color: transparent;
            border: 4px solid #4CAF50;
            width: 24px;
            height: 24px;
        }
        .not-level .leveler-error-zone {
            opacity: 0.6;
        }

        /* 十字准星装饰 */
        .crosshair {
            position: absolute;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        .crosshair::before, .crosshair::after {
            content: '';
            position: absolute;
            background-color: rgba(0,0,0,0.1);
        }
        .crosshair::before {
            top: 50%; left: 10%; right: 10%; height: 2px;
        }
        .crosshair::after {
            left: 50%; top: 10%; bottom: 10%; width: 2px;
        }

        /* 中下部：计时器 */
        .timer-display {
            font-family: 'Fredoka One', cursive;
            font-size: 10vmin;
            color: var(--text-color);
            margin: 2vh 0;
            font-variant-numeric: tabular-nums;
            letter-spacing: 2px;
        }

        /* 下部：按钮区 */
        .controls {
            margin-top: auto;
            margin-bottom: 4vh;
            display: flex;
            gap: 20px;
        }

        .btn {
            background-color: var(--accent-color);
            color: #FFF;
            border: none;
            font-family: 'Fredoka One', cursive;
            font-size: 24px;
            width: 16vmin;
            height: 16vmin;
            min-width: 80px;
            min-height: 80px;
            border-radius: 35%; /* Squircle / Loaf shape */
            cursor: pointer;
            box-shadow: 0 6px 0 var(--btn-shadow);
            transition: transform 0.1s, box-shadow 0.1s;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        .btn:active {
            transform: translateY(6px) scale(0.95);
            box-shadow: 0 0 0 var(--btn-shadow);
        }
        
        /* 倒计时状态下的按钮 */
        .btn.counting {
            font-size: 32px;
            pointer-events: none; /* 禁止点击 */
            filter: brightness(0.9);
        }

        /* 图标 SVG */
        .icon {
            width: 60%;
            height: 60%;
            fill: currentColor;
        }

        /* 弹窗提示 */
        .toast {
            position: absolute;
            bottom: 20%;
            background-color: rgba(255, 107, 107, 0.9);
            color: white;
            padding: 12px 24px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 1.2rem;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.3s, transform 0.3s;
            pointer-events: none;
            z-index: 100;
        }
        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }

        /* 隐藏元素 */
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body class="spring"> <!-- 默认春季 -->

    <!-- Canvas 用于粒子 -->
    <canvas id="particleCanvas"></canvas>

    <!-- 木纹装饰层 -->
    <div class="wood-layer"></div>

    <!-- UI 内容层 -->
    <div class="ui-container">
        <!-- 角度 -->
        <div class="angle-display" id="angleText">【0°】</div>

        <!-- 水平仪 -->
        <div class="leveler-container" id="leveler">
            <div class="leveler-ring"></div>
            <div class="crosshair"></div>
            <div class="leveler-error-zone"></div>
            <div class="leveler-bubble" id="bubble"></div>
        </div>

        <!-- 计时器 -->
        <div class="timer-display" id="timer">00 : 00 : 00</div>

        <!-- 按钮区 -->
        <div class="controls">
            <!-- 播放/倒计时/暂停按钮 -->
            <button class="btn" id="mainBtn">
                <svg class="icon" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
            </button>
            <!-- 重新开始按钮 (默认隐藏) -->
            <button class="btn hidden" id="resetBtn">
                <svg class="icon" viewBox="0 0 24 24"><path d="M12 5V1L7 6l5 5V7c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6H4c0 4.42 3.58 8 8 8s8-3.58 8-8-3.58-8-8-8z"/></svg>
            </button>
        </div>
    </div>

    <!-- 提示框 -->
    <div class="toast" id="toast">请保持设备水平</div>

    <script>
        /**
         * 状态机与配置
         */
        const STATE = {
            IDLE: 'IDLE',
            COUNTDOWN: 'COUNTDOWN',
            RUNNING: 'RUNNING',
            PAUSED: 'PAUSED'
        };

        const THEMES = ['spring', 'summer', 'autumn', 'winter', 'dark'];
        
        let currentState = STATE.IDLE;
        let currentThemeIndex = 0;
        let timerInterval = null;
        let startTime = 0;
        let elapsedBeforePause = 0; // 毫秒
        
        // 水平仪配置
        const MAX_TILT = 45; // 最大显示倾斜度
        const TOLERANCE = 3; // 容差度数
        let currentBeta = 0; // X轴倾斜 (前后)
        let currentGamma = 0; // Y轴倾斜 (左右)
        let isLevel = true;

        // DOM 元素
        const dom = {
            body: document.body,
            angle: document.getElementById('angleText'),
            leveler: document.getElementById('leveler'),
            bubble: document.getElementById('bubble'),
            timer: document.getElementById('timer'),
            mainBtn: document.getElementById('mainBtn'),
            resetBtn: document.getElementById('resetBtn'),
            toast: document.getElementById('toast'),
            canvas: document.getElementById('particleCanvas')
        };

        // 图标 SVG 字符串
        const ICONS = {
            play: '<svg class="icon" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>',
            pause: '<svg class="icon" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>',
            reset: '<svg class="icon" viewBox="0 0 24 24"><path d="M12 5V1L7 6l5 5V7c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6H4c0 4.42 3.58 8 8 8s8-3.58 8-8-3.58-8-8-8z"/></svg>'
        };

        /**
         * 粒子系统
         */
        const ctx = dom.canvas.getContext('2d');
        let particles = [];
        let animationId;
        
        // 调整 Canvas 尺寸
        function resizeCanvas() {
            dom.canvas.width = window.innerWidth;
            dom.canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        class Particle {
            constructor() {
                this.reset(true);
            }

            reset(top = false) {
                this.x = Math.random() * dom.canvas.width;
                this.y = top ? Math.random() * dom.canvas.height : -20;
                this.size = (Math.random() * 0.5 + 0.5) * (dom.body.classList.contains('dark') ? 4 : 10);
                // 1:2:1 比例生成大小
                const sizeRoll = Math.random();
                if(sizeRoll < 0.25) this.size *= 0.6; // 小
                else if(sizeRoll > 0.75) this.size *= 1.4; // 大
                
                this.speedY = Math.random() * 1 + 1;
                this.speedX = Math.random() * 2 - 1;
                this.rotation = Math.random() * 360;
                this.rotationSpeed = Math.random() * 2 - 1;
                this.opacity = Math.random() * 0.5 + 0.5;
                this.oscillation = Math.random() * 0.05;
            }

            draw() {
                ctx.save();
                ctx.translate(this.x, this.y);
                ctx.rotate(this.rotation * Math.PI / 180);
                ctx.globalAlpha = this.opacity;
                
                const theme = THEMES[currentThemeIndex];
                
                if (theme === 'spring') {
                    // 花瓣
                    ctx.fillStyle = '#FFB7B2';
                    ctx.beginPath();
                    ctx.ellipse(0, 0, this.size, this.size * 0.6, 0, 0, Math.PI * 2);
                    ctx.fill();
                } else if (theme === 'summer') {
                    // 泡泡
                    ctx.strokeStyle = '#FFFFFF';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.arc(0, 0, this.size * 0.8, 0, Math.PI * 2);
                    ctx.stroke();
                    // 高光
                    ctx.fillStyle = 'rgba(255,255,255,0.6)';
                    ctx.beginPath();
                    ctx.arc(this.size * -0.3, this.size * -0.3, this.size * 0.2, 0, Math.PI * 2);
                    ctx.fill();
                } else if (theme === 'autumn') {
                    // 枫叶 (菱形模拟)
                    ctx.fillStyle = '#E76F51';
                    ctx.beginPath();
                    ctx.moveTo(0, -this.size);
                    ctx.lineTo(this.size * 0.8, 0);
                    ctx.lineTo(0, this.size);
                    ctx.lineTo(-this.size * 0.8, 0);
                    ctx.fill();
                } else if (theme === 'winter') {
                    // 雪花
                    ctx.fillStyle = '#E0FBFC';
                    ctx.beginPath();
                    ctx.arc(0, 0, this.size * 0.6, 0, Math.PI * 2);
                    ctx.fill();
                } else if (theme === 'dark') {
                    // 萤火虫
                    ctx.fillStyle = '#F4D35E';
                    ctx.shadowColor = '#F4D35E';
                    ctx.shadowBlur = 10;
                    ctx.beginPath();
                    ctx.arc(0, 0, this.size, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.shadowBlur = 0;
                }

                ctx.restore();
            }

            update() {
                // 如果是暂停状态，不更新位置（时间停止魔法）
                if (currentState === STATE.PAUSED || currentState === STATE.IDLE) return;

                this.y += this.speedY;
                this.x += Math.sin(this.y * this.oscillation) + this.speedX * 0.2;
                this.rotation += this.rotationSpeed;

                if (this.y > dom.canvas.height + 20) {
                    if (currentState === STATE.RUNNING) {
                         this.reset();
                    }
                }
            }
        }

        function initParticles() {
            particles = [];
            for (let i = 0; i < 50; i++) {
                particles.push(new Particle());
            }
        }

        function animateParticles() {
            ctx.clearRect(0, 0, dom.canvas.width, dom.canvas.height);
            
            // 如果是 IDLE 状态，且需要清空粒子（飘出屏幕）
            if (currentState === STATE.IDLE && particles.length > 0) {
                 let activeParticles = 0;
                 particles.forEach(p => {
                     p.y += p.speedY * 2; // 加速落下
                     p.rotation += p.rotationSpeed;
                     p.draw();
                     if (p.y < dom.canvas.height + 50) activeParticles++;
                 });
                 if (activeParticles === 0) particles = []; // 清空
            } else {
                particles.forEach(p => {
                    p.update();
                    p.draw();
                });
            }
            
            requestAnimationFrame(animateParticles);
        }
        
        // 启动渲染循环
        initParticles();
        animateParticles();

        /**
         * 逻辑控制
         */

        // 格式化时间
        function formatTime(ms) {
            const totalSeconds = Math.floor(ms / 1000);
            const h = Math.floor(totalSeconds / 3600);
            const m = Math.floor((totalSeconds % 3600) / 60);
            const s = totalSeconds % 60;
            return [h, m, s].map(v => v.toString().padStart(2, '0')).join(' : ');
        }

        // 更新 UI (角度与水平仪)
        function updateOrientationUI() {
            const maxTiltAngle = Math.max(Math.abs(currentBeta), Math.abs(currentGamma));
            dom.angle.innerText = `【${Math.round(maxTiltAngle)}°】`;

            // 移动气泡
            // 将角度映射到像素移动。假设 45度 = 容器半径
            const rect = dom.leveler.getBoundingClientRect();
            const radius = rect.width / 2;
            
            // 限制气泡在圆环内
            let moveX = (currentGamma / MAX_TILT) * radius;
            let moveY = (currentBeta / MAX_TILT) * radius;
            
            const distance = Math.sqrt(moveX*moveX + moveY*moveY);
            if (distance > radius - 15) {
                const angle = Math.atan2(moveY, moveX);
                moveX = Math.cos(angle) * (radius - 15);
                moveY = Math.sin(angle) * (radius - 15);
            }

            dom.bubble.style.transform = `translate(${moveX}px, ${moveY}px)`;

            // 判断水平
            const wasLevel = isLevel;
            isLevel = maxTiltAngle <= TOLERANCE;

            if (isLevel) {
                dom.leveler.classList.add('is-level');
                dom.leveler.classList.remove('not-level');
                if (dom.toast.classList.contains('show')) dom.toast.classList.remove('show');
            } else {
                dom.leveler.classList.remove('is-level');
                dom.leveler.classList.add('not-level');
            }

            // 状态触发逻辑
            if (currentState === STATE.RUNNING && !isLevel) {
                pauseTimer("不平");
            } else if (currentState === STATE.COUNTDOWN && !isLevel && countdownVal <= 0) {
                 // 倒计时结束那刻不平
                 showToast();
            }
        }

        function showToast() {
            dom.toast.classList.add('show');
            setTimeout(() => dom.toast.classList.remove('show'), 2000);
        }

        // 计时器主逻辑
        function startTimer() {
            currentState = STATE.RUNNING;
            startTime = Date.now() - elapsedBeforePause;
            
            // UI 更新
            dom.mainBtn.innerHTML = ICONS.pause;
            dom.resetBtn.classList.add('hidden');
            
            // 粒子生成逻辑：如果是重新开始，重置粒子位置在顶部；如果是继续，位置不变
            if (elapsedBeforePause === 0) {
                initParticles();
                particles.forEach(p => p.y = -20 - Math.random() * 200); // 从顶部生成
            }
            
            timerInterval = setInterval(() => {
                const now = Date.now();
                const elapsed = now - startTime;
                dom.timer.innerText = formatTime(elapsed);
            }, 100);
        }

        function pauseTimer(reason) {
            if (currentState !== STATE.RUNNING) return;
            
            currentState = STATE.PAUSED;
            clearInterval(timerInterval);
            elapsedBeforePause = Date.now() - startTime;
            
            // UI 更新
            dom.mainBtn.innerHTML = ICONS.play;
            dom.resetBtn.classList.remove('hidden');
            
            if (reason === "不平") {
                showToast();
            }
        }

        function resetTimer() {
            clearInterval(timerInterval);
            currentState = STATE.IDLE;
            elapsedBeforePause = 0;
            dom.timer.innerText = "00 : 00 : 00";
            dom.mainBtn.innerHTML = ICONS.play;
            dom.mainBtn.classList.remove('counting');
            dom.resetBtn.classList.add('hidden');
            
            // 让现有粒子飘走
        }

        let countdownVal = 5;
        function startCountdown() {
            // 请求权限 (iOS 13+)
            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission()
                    .then(permissionState => {
                        if (permissionState !== 'granted') {
                            alert('需要陀螺仪权限才能检测水平');
                            return;
                        }
                    })
                    .catch(console.error);
            }

            currentState = STATE.COUNTDOWN;
            countdownVal = 5;
            dom.mainBtn.innerText = countdownVal;
            dom.mainBtn.classList.add('counting');
            dom.resetBtn.classList.add('hidden');

            const intv = setInterval(() => {
                countdownVal--;
                if (countdownVal > 0) {
                    dom.mainBtn.innerText = countdownVal;
                } else {
                    clearInterval(intv);
                    dom.mainBtn.classList.remove('counting');
                    
                    // 检测水平
                    if (isLevel) {
                        startTimer();
                    } else {
                        // 倒计时结束但不平
                        dom.mainBtn.innerText = "!";
                        showToast();
                        // 此时状态该如何？回到 Pause 状态允许重试
                        currentState = STATE.PAUSED;
                        dom.mainBtn.innerHTML = ICONS.play;
                        dom.resetBtn.classList.remove('hidden');
                    }
                }
            }, 1000);
        }

        /**
         * 事件监听
         */

        // 按钮点击
        dom.mainBtn.addEventListener('click', () => {
            if (currentState === STATE.IDLE || currentState === STATE.PAUSED) {
                startCountdown();
            } else if (currentState === STATE.RUNNING) {
                pauseTimer("手动");
            }
        });

        dom.resetBtn.addEventListener('click', resetTimer);

        // 主题切换
        document.addEventListener('keydown', (e) => {
            if (e.code === 'Space') {
                dom.body.classList.remove(THEMES[currentThemeIndex]);
                currentThemeIndex = (currentThemeIndex + 1) % THEMES.length;
                dom.body.classList.add(THEMES[currentThemeIndex]);
                // 如果在 IDLE 态刷新粒子样式供预览
                if(currentState === STATE.IDLE) initParticles();
            }
        });

        // 陀螺仪处理
        window.addEventListener('deviceorientation', (event) => {
            // Beta: x轴 (前后倾斜), Gamma: y轴 (左右倾斜)
            // 限制范围在 -90 到 90 方便计算
            let b = event.beta; 
            let g = event.gamma;
            
            if (b > 90) b = 90;
            if (b < -90) b = -90;
            
            currentBeta = b || 0;
            currentGamma = g || 0;
            
            updateOrientationUI();
        });

        // PC 鼠标模拟
        window.addEventListener('mousemove', (e) => {
            // 仅当非移动设备（检测不到陀螺仪事件或手动测试）时有效
            // 这里简单共存，方便调试
            if (!/Mobi|Android/i.test(navigator.userAgent)) {
                const centerX = window.innerWidth / 2;
                const centerY = window.innerHeight / 2;
                
                // 将鼠标距离中心的距离映射到角度
                // 假设从中心到边缘是 45 度
                const maxDistX = window.innerWidth / 2;
                const maxDistY = window.innerHeight / 2;
                
                currentGamma = ((e.clientX - centerX) / maxDistX) * 45; // 左右
                currentBeta = ((e.clientY - centerY) / maxDistY) * 45; // 前后
                
                updateOrientationUI();
            }
        });

        // Page Visibility (切屏、息屏检测)
        document.addEventListener('visibilitychange', () => {
            if (document.hidden && currentState === STATE.RUNNING) {
                pauseTimer("后台");
            }
        });

        // 初始化
        updateOrientationUI();

    </script>
</body>
</html>
