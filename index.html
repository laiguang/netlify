<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cozy Focus Timer</title>
    <!-- 引入圆润可爱的字体 -->
    <link href="https://fonts.googleapis.com/css2?family=Varela+Round&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #ccdbdc;
            --container-bg: #ebf5f7;
            --accent-light: #9ad1d4;
            --accent-med: #80ced7;
            --text-color: #007ea7;
            --danger-glow: 0 0 15px rgba(255, 80, 80, 0.8);
            --success-glow: 0 0 15px rgba(100, 255, 120, 0.8);
            --glass-border: rgba(255, 255, 255, 0.6);
            --glass-bg: rgba(255, 255, 255, 0.25);
        }

        * {
            box-sizing: border-box;
            user-select: none;
            -webkit-user-select: none;
        }

        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            font-family: 'Varela Round', sans-serif;
            background-color: var(--bg-color);
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            color: var(--text-color);
        }

        /* 雪花 Canvas 层 */
        #snow-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }

        /* 主容器 */
        .container {
            background-color: var(--container-bg);
            width: 90vw;
            max-width: 500px;
            height: 80vh;
            max-height: 800px;
            border-radius: 40px;
            box-shadow: 0 10px 25px rgba(0, 56, 74, 0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            padding: 40px 20px;
            position: relative;
            z-index: 5;
            transition: transform 0.3s ease;
        }

        /* 上部：角度显示 */
        .angle-display {
            font-size: 2rem;
            font-weight: bold;
            color: var(--text-color);
            margin-bottom: 20px;
            height: 50px;
            display: flex;
            align-items: center;
        }

        /* 中上部：水平仪 */
        .level-wrapper {
            position: relative;
            width: 200px;
            height: 200px;
            border-radius: 50%;
            background: var(--glass-bg);
            border: 2px solid var(--glass-border);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px); /* Safari */
            display: flex;
            justify-content: center;
            align-items: center;
            transition: box-shadow 0.3s ease;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }

        /* 状态霓虹光 */
        .level-wrapper.status-green {
            box-shadow: var(--success-glow), inset 0 0 20px rgba(255,255,255,0.5);
            border-color: #b0ffc6;
        }

        .level-wrapper.status-red {
            box-shadow: var(--danger-glow), inset 0 0 20px rgba(255,200,200,0.3);
            border-color: #ffb0b0;
        }

        /* 误差虚线圆环 */
        .target-ring {
            position: absolute;
            width: 40px;
            height: 40px;
            border: 2px dashed var(--text-color);
            border-radius: 50%;
            opacity: 0.5;
        }

        /* 气泡/指针 */
        .bubble {
            width: 30px;
            height: 30px;
            background-color: var(--text-color);
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: transform 0.1s linear; /* 平滑移动 */
        }

        /* 中下部：计时器 */
        .timer-display {
            font-size: 3rem;
            font-weight: bold;
            color: var(--text-color);
            margin: 20px 0;
            font-variant-numeric: tabular-nums; /* 等宽数字防止抖动 */
        }

        /* 下部：按钮区 */
        .controls {
            display: flex;
            gap: 20px;
            height: 80px;
            align-items: center;
        }

        .btn {
            background-color: var(--accent-med);
            border: none;
            width: 70px;
            height: 70px;
            /* 面包形状：稍微平一点的圆角 */
            border-radius: 20px; 
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            color: white;
            font-size: 1.5rem;
            box-shadow: 0 4px 0 #007ea7; /* 3D 效果 */
            transition: all 0.1s ease;
            outline: none;
            font-family: 'Varela Round', sans-serif;
        }

        .btn:active {
            transform: translateY(4px);
            box-shadow: 0 0 0 #007ea7;
        }

        .btn.hidden {
            display: none;
        }

        /* SVG 图标样式 */
        .btn svg {
            width: 32px;
            height: 32px;
            fill: white;
        }

        /* 倒计时文字样式 */
        .btn-text {
            font-size: 1.8rem;
            font-weight: bold;
        }

    </style>
</head>
<body>

    <canvas id="snow-canvas"></canvas>

    <div class="container">
        <!-- 角度 -->
        <div class="angle-display" id="angleText">0°</div>

        <!-- 水平仪 -->
        <div class="level-wrapper status-green" id="level">
            <div class="target-ring"></div>
            <div class="bubble" id="bubble"></div>
        </div>

        <!-- 计时器 -->
        <div class="timer-display" id="timer">00 : 00 : 00</div>

        <!-- 按钮 -->
        <div class="controls">
            <!-- 播放/倒计时按钮 -->
            <button class="btn" id="playBtn">
                <svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
            </button>
            
            <!-- 重新开始按钮 (默认隐藏) -->
            <button class="btn hidden" id="restartBtn">
                <svg viewBox="0 0 24 24"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-8 8h2c0-3.31 2.69-6 6-6 1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
            </button>
        </div>
    </div>

<script>
    /**
     * 全局变量与配置
     */
    const ALLOWED_ANGLE = 3; // 允许的误差角度
    const COUNTDOWN_SECONDS = 5; // 倒计时秒数
    const MAX_TILT_VISUAL = 45; // 视觉上水平仪的最大倾斜显示范围（度）
    const LEVEL_RADIUS = 100; // 水平仪半径 px
    const BUBBLE_RADIUS = 15; // 气泡半径 px

    // DOM 元素
    const angleText = document.getElementById('angleText');
    const levelEl = document.getElementById('level');
    const bubbleEl = document.getElementById('bubble');
    const timerEl = document.getElementById('timer');
    const playBtn = document.getElementById('playBtn');
    const restartBtn = document.getElementById('restartBtn');
    const canvas = document.getElementById('snow-canvas');
    const ctx = canvas.getContext('2d');

    // 状态管理
    let state = {
        phase: 'idle', // idle, countdown, running, paused
        startTime: 0,
        elapsed: 0,
        tiltX: 0, // 范围大致在 -90 到 90
        tiltY: 0,
        tiltMagnitude: 0,
        countdownValue: 5,
        timerInterval: null,
        countdownInterval: null
    };

    // 设备检测
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

    /**
     * 雪花系统 (Canvas)
     */
    let snowflakes = [];
    let w, h;

    function resizeCanvas() {
        w = canvas.width = window.innerWidth;
        h = canvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    class Snowflake {
        constructor() {
            this.init(true);
        }

        init(fromTop = false) {
            this.x = Math.random() * w;
            this.y = fromTop ? Math.random() * h : -10;
            this.size = Math.random() * 4 + 2; // 2px - 6px
            this.speedY = Math.random() * 1 + 0.5;
            this.speedX = Math.random() * 0.5 - 0.25;
            this.opacity = Math.random() * 0.5 + 0.3;
        }

        draw() {
            ctx.beginPath();
            ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
            ctx.fillStyle = `rgba(255, 255, 255, ${this.opacity})`;
            ctx.fill();
            
            // 模糊效果模拟
            // 性能提示：shadowBlur 在大量粒子下可能卡顿，这里简单模拟
        }

        update() {
            // 只有在 running 状态下才移动
            if (state.phase === 'running') {
                this.y += this.speedY;
                this.x += this.speedX;

                if (this.y > h) {
                    this.init();
                    this.y = -10;
                }
                if (this.x > w) this.x = 0;
                if (this.x < 0) this.x = w;
            } else if (state.phase === 'idle') {
                // 如果是 idle 状态，让存在的雪花飘走
                this.y += this.speedY * 2;
                this.x += this.speedX * 2;
            }
            // paused 和 countdown 状态下，雪花静止 (Time Stop)
        }
    }

    function snowLoop() {
        ctx.clearRect(0, 0, w, h);
        
        // 生成逻辑
        if (state.phase === 'running' && snowflakes.length < 100) {
            if (Math.random() < 0.1) snowflakes.push(new Snowflake());
        }

        // 更新和绘制
        for (let i = snowflakes.length - 1; i >= 0; i--) {
            snowflakes[i].update();
            snowflakes[i].draw();
            
            // 如果在 idle 状态且飘出屏幕，移除
            if (state.phase === 'idle' && snowflakes[i].y > h) {
                snowflakes.splice(i, 1);
            }
        }
        
        requestAnimationFrame(snowLoop);
    }
    snowLoop(); // 启动循环

    /**
     * 水平仪与倾斜逻辑
     */
    function updateLevelVisuals() {
        // 限制移动范围在圆内
        const maxDist = LEVEL_RADIUS - BUBBLE_RADIUS;
        
        // 将角度映射到像素移动 (简单的线性映射)
        // 假设 45度 对应 边缘
        let moveX = (state.tiltX / MAX_TILT_VISUAL) * maxDist;
        let moveY = (state.tiltY / MAX_TILT_VISUAL) * maxDist;

        // 限制在圆内
        const dist = Math.sqrt(moveX*moveX + moveY*moveY);
        if (dist > maxDist) {
            const ratio = maxDist / dist;
            moveX *= ratio;
            moveY *= ratio;
        }

        bubbleEl.style.transform = `translate(calc(-50% + ${moveX}px), calc(-50% + ${moveY}px))`;

        // 计算总倾斜度 (取最大值或者向量长)
        state.tiltMagnitude = Math.sqrt(state.tiltX*state.tiltX + state.tiltY*state.tiltY);
        
        angleText.innerText = `${Math.round(state.tiltMagnitude)}°`;

        // 更新颜色状态
        const isFlat = state.tiltMagnitude <= ALLOWED_ANGLE;
        if (isFlat) {
            levelEl.classList.add('status-green');
            levelEl.classList.remove('status-red');
        } else {
            levelEl.classList.add('status-red');
            levelEl.classList.remove('status-green');
        }

        // 核心逻辑：如果在计时中，检测到不平
        if (state.phase === 'running' && !isFlat) {
            handleDisruption();
        }
    }

    // 处理 PC 鼠标模拟
    window.addEventListener('mousemove', (e) => {
        if (isMobile) return; // 手机上禁用鼠标逻辑
        
        const rect = levelEl.getBoundingClientRect();
        const centerX = rect.left + rect.width / 2;
        const centerY = rect.top + rect.height / 2;
        
        // 计算鼠标相对于中心的百分比 (-1 to 1)
        const dx = (e.clientX - centerX) / (window.innerWidth / 2);
        const dy = (e.clientY - centerY) / (window.innerHeight / 2);

        // 模拟角度
        state.tiltX = dx * 90; 
        state.tiltY = dy * 90;
        
        updateLevelVisuals();
    });

    // 处理移动端陀螺仪
    function handleOrientation(event) {
        if (!event.gamma && !event.beta) return;
        
        // Gamma: 左-右倾斜 (-90 to 90)
        // Beta: 前-后倾斜 (-180 to 180)
        
        // 简单的校准：手机平放桌上时，beta 和 gamma 应该接近 0
        state.tiltX = event.gamma; 
        state.tiltY = event.beta;

        updateLevelVisuals();
    }

    /**
     * 计时器与游戏流程逻辑
     */
    function formatTime(ms) {
        const totalSeconds = Math.floor(ms / 1000);
        const h = Math.floor(totalSeconds / 3600);
        const m = Math.floor((totalSeconds % 3600) / 60);
        const s = totalSeconds % 60;
        return `${String(h).padStart(2, '0')} : ${String(m).padStart(2, '0')} : ${String(s).padStart(2, '0')}`;
    }

    function updateTimerDisplay() {
        const currentElapsed = Date.now() - state.startTime + state.elapsed;
        timerEl.innerText = formatTime(currentElapsed);
    }

    function startCountdown() {
        // 请求 iOS 权限 (必须在点击事件中触发)
        if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
            DeviceOrientationEvent.requestPermission()
                .then(response => {
                    if (response === 'granted') {
                        window.addEventListener('deviceorientation', handleOrientation);
                    }
                })
                .catch(console.error);
        } else {
            // 非 iOS 13+ 或 安卓
            window.addEventListener('deviceorientation', handleOrientation);
        }

        state.phase = 'countdown';
        state.countdownValue = COUNTDOWN_SECONDS;
        restartBtn.classList.add('hidden'); // 倒计时期间隐藏重置
        
        playBtn.innerHTML = `<span class="btn-text">${state.countdownValue}</span>`;
        playBtn.disabled = true; // 禁用点击

        state.countdownInterval = setInterval(() => {
            state.countdownValue--;
            if (state.countdownValue > 0) {
                playBtn.innerHTML = `<span class="btn-text">${state.countdownValue}</span>`;
            } else {
                // 倒计时结束
                clearInterval(state.countdownInterval);
                checkStartConditions();
            }
        }, 1000);
    }

    function checkStartConditions() {
        // 检查是否水平
        if (state.tiltMagnitude <= ALLOWED_ANGLE) {
            // 开始计时
            state.phase = 'running';
            state.startTime = Date.now();
            
            // 按钮变暂停图标
            playBtn.innerHTML = `<svg viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>`;
            playBtn.disabled = false;
            
            // 启动计时器 Interval
            state.timerInterval = setInterval(updateTimerDisplay, 100);
        } else {
            // 失败：设备不平
            alert("请保持设备水平！");
            resetToPauseState();
        }
    }

    function handleDisruption() {
        // 当设备移动或暂停时
        clearInterval(state.timerInterval);
        state.elapsed += Date.now() - state.startTime; // 保存已逝去的时间
        state.phase = 'paused';
        
        // 按钮变回播放
        playBtn.innerHTML = `<svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>`;
        restartBtn.classList.remove('hidden'); // 显示重新开始
    }

    function resetToPauseState() {
        // 用于倒计时失败后的重置
        state.phase = 'paused';
        playBtn.innerHTML = `<svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>`;
        playBtn.disabled = false;
        restartBtn.classList.remove('hidden');
    }

    function fullReset() {
        clearInterval(state.timerInterval);
        clearInterval(state.countdownInterval);
        state.phase = 'idle';
        state.elapsed = 0;
        state.startTime = 0;
        
        timerEl.innerText = "00 : 00 : 00";
        playBtn.innerHTML = `<svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>`;
        playBtn.disabled = false;
        restartBtn.classList.add('hidden');
        
        // 雪花在 update 循环中会自动飘走
    }

    // 按钮事件绑定
    playBtn.addEventListener('click', () => {
        if (state.phase === 'idle' || state.phase === 'paused') {
            startCountdown();
        } else if (state.phase === 'running') {
            // 手动暂停
            handleDisruption();
        }
    });

    restartBtn.addEventListener('click', fullReset);

</script>
</body>
</html>
